- name: House Consumption
  state: >
    {% set input_power = states('sensor.input_power') | float %}
    {% set active_power = states('sensor.active_power') | float %}
    {% set charge_discharge_power = states('sensor.charge_discharge_power') | float %}
    {% set grid_active_power = states('sensor.grid_active_power') | float %}
    {{ active_power - grid_active_power }}

- name: Battery Allow Charge From Grid
  state: >
    {% set max_price = state_attr('sensor.nordpool_kwh_se3_sek_2_10_025', 'max') %}
    {% set current_price = state_attr('sensor.nordpool_kwh_se3_sek_2_10_025', 'current_price') %}
    {% set average = state_attr('sensor.nordpool_kwh_se3_sek_2_10_025', 'average') %}
    {% set off_peak_1 = state_attr('sensor.nordpool_kwh_se3_sek_2_10_025', 'off_peak_1') %}
    {% set off_peak_2 = state_attr('sensor.nordpool_kwh_se3_sek_2_10_025', 'off_peak_2') %}
    {% set peak = state_attr('sensor.nordpool_kwh_se3_sek_2_10_025', 'peak') %}
    {% set min = state_attr('sensor.nordpool_kwh_se3_sek_2_10_025', 'min') %}
    {% set max = state_attr('sensor.nordpool_kwh_se3_sek_2_10_025', 'max') %}

    {% set current_hour = now().hour %}
    {% set threshold_factor = 1.8 %}
    {% set day_average = average %} 

    {% if current_hour < 8 %}
      {% set local_avg = off_peak_1 %}
    {% endif %}
    {% if current_hour >= 8 and current_hour < 20 %}
      {% set local_avg = peak %}
    {% endif %}
    {% if current_hour >= 20 %}
      {% set local_avg = off_peak_2 %}
    {% endif %}

    {% set day_average_factor = day_average / current_price %}
    {% set local_average_factor = local_avg / current_price %}
    {{ (day_average_factor * local_average_factor / threshold_factor) | round(3) }}
